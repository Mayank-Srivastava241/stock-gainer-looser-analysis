name: Run project

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt

      # 4. Prepare required directories
      - name: Prepare directories
        run: |
          mkdir -p creds loggs Data

      # 5. Create credential files from GitHub secrets
      - name: Create credential files from secrets
        env:
          API_KEY: ${{ secrets.API_KEY }}
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          if [ -z "$API_KEY" ] || [ -z "$TOKEN" ]; then
            echo "ERROR: API_KEY or TOKEN secret is missing"
            exit 1
          fi

          printf '%s' "$API_KEY" > creds/oauth_secret.json
          printf '%s' "$TOKEN" > creds/token.json

      # 6. Install Playwright browser (Chromium)
      - name: Install Playwright browser
        run: |
          npx playwright install chromium

      # 7. Run the project
      - name: Run project
        env:
          API_KEY_PATH: creds/oauth_secret.json
          TOKEN_PATH: creds/token.json
        run: |
          python main.py

      # 8. Upload Data and logs (even if job fails)
      - name: Upload artifacts (Data and logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-output
          path: |
            Data/
            loggs/
